
<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <!-- <title>SVD Decompositon in LLM Compression</title> -->

        <link rel="stylesheet" href="https://cdn.bootcss.com/reveal.js/3.4.1/css/reveal.min.css">

        <!-- style -->

        <style>

            .reveal.fullscreen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 1000;
                background-color: white;
            }

            .reveal:not(.fullscreen) {
                width: 100%;
                height: 600px;
                margin: 2rem 0;
                position: relative;
            }

            #fullscreen-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                width: 32px;
                height: 32px;
                background-color: rgba(0, 0, 0, 0.6);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                z-index: 1001;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #laser-btn {
                position: fixed;
                left: 20px;
                bottom: 20px;
                width: 32px;
                height: 32px;
                background-color: rgba(0, 0, 0, 0.6);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                z-index: 1001;
                display: none;
                align-items: center;
                justify-content: center;
            }

            #laser-btn:hover {
                background-color: rgba(0, 0, 0, 0.8);
            }

            #laser-btn.active {
                background-color: rgba(255, 0, 0, 0.6);
            }

            .laser-pointer {
                position: fixed;
                width: 0.6rem;
                height: 0.6rem;
                background-color: red;
                border-radius: 50%;
                pointer-events: none;
                z-index: 9999;
                display: none;
                box-shadow: 0 0 0.25rem 0.15rem rgba(255, 0, 0, 0.5);
            }

            .cursor-hidden {
                cursor: none !important;
            }
            
            .cursor-hidden * {
                cursor: none !important;
            }

            .reveal .slides section:not(:first-child) {
                top: 0 !important;
                transform: none !important;
            }
            
            /* åªå–æ¶ˆéé¦–é¡µçš„å‚ç›´å±…ä¸­ */
            .reveal .slides section:not(:first-child) {
                top: 0 !important;
                bottom: 0 !important;
                transform: none !important;
            }

            /* é¦–é¡µä¿æŒ Reveal.js é»˜è®¤çš„å‚ç›´å±…ä¸­ */
            .reveal .slides section:first-child h1,
            .reveal .slides section:first-child h2,
            .reveal .slides section:first-child h3 {
                text-align: center;
                text-transform: capitalize;
                font-size: 6em;
            }

            /* å…¶ä»–é¡µé¢çš„æ ‡é¢˜å›ºå®šåœ¨å·¦ä¸Šè§’ */
            .reveal .slides section:not(:first-child) h1,
            .reveal .slides section:not(:first-child) h2,
            .reveal .slides section:not(:first-child) h3 {
                position: absolute;
                top: 0;
                left: -4rem;
            }

            /* ä¸ºä¸åŒçº§åˆ«çš„æ ‡é¢˜è®¾ç½®ä¸åŒçš„å­—ä½“å¤§å° */
            .reveal .slides section:not(:first-child) h1 { font-size: 55px; }
            .reveal .slides section:not(:first-child) h2 { font-size: 55px; }
            .reveal .slides section:not(:first-child) h3 { font-size: 45px; }

            /* ä¸ºæ•´ä¸ª section æ·»åŠ ä¸Šå†…è¾¹è·ï¼Œé˜²æ­¢å†…å®¹ä¸æ ‡é¢˜é‡å  */
            .reveal .slides section:not(:first-child) {
                padding-top: 1.7em; 
            }

            /* å…¶ä»–é¡µé¢çš„ä¸»è¦å†…å®¹åŒºåŸŸæ·»åŠ ä¸Šè¾¹è· */
            .reveal .slides section:not(:first-child) > *:not(h1):not(h2):not(h3) {
                margin-top: 1em;
                font-size: 0.8em;
            }

            /* ä¿æŒå†…å®¹å·¦å¯¹é½ */
            .reveal .slides section:not(:first-child) {
                text-align: left;
            }

            /* åˆ—è¡¨é¡¹å·¦å¯¹é½ */
            .reveal .slides section ul,
            .reveal .slides section ol {
                display: block;
                text-align: left;
            }

            /* ä»£ç å—å·¦å¯¹é½ */
            .reveal .slides section pre {
                width: auto;
                text-align: left;
            }

            .reveal .slides section .mjx-chtml {
                text-align: left !important;
                margin-left: 0 !important;
            }

            /* æ™®é€šæ®µè½å·¦å¯¹é½ */

            .reveal .slides section {
                text-align: left;
                font-size: 40px;
            }
            .reveal .slides section p {
                text-align: left;
            }
            .reveal .slides section ul > li {
                font-size: 1em !important; /* è®¾ç½®ä¸€çº§åˆ—è¡¨é¡¹çš„å­—ä½“å¤§å° */
            }
            .reveal .slides section ul ul > li {
                font-size: 0.8em !important; /* è®¾ç½®äºŒçº§åˆ—è¡¨é¡¹çš„å­—ä½“å¤§å° */
            }
            .reveal .slides section ul ul ul > li {
                font-size: 0.7em !important; /* è®¾ç½®ä¸‰çº§åˆ—è¡¨é¡¹çš„å­—ä½“å¤§å° */
            }
            
            /* å…¬å¼å·¦å¯¹é½ */
            /* .reveal .slides section .MathJax_Display {
                text-align: left !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            } */
            
            
            /* Slide çš„è®¾ç½® */
            .reveal .slides .slide-cols{
                display: flex;
            }
            .reveal .slides .slide-col-half{
                flex: 1;
            }
            .reveal .slides .slide-col-4{
                flex: 4;
            }
            .reveal .slides .slide-col-6{
                flex: 6;
            }

            .reveal .slides .slide-img{
                text-align: center; 
                padding: 0;
                display: block;
                border: none;
            }
            .reveal .slides .slide-ref{
                position: absolute; 
                bottom: 0; left: 0; 
                font-size: 0.5em !important;
                text-align: left; 
                width: 100%;
            }
            .reveal .slide-number {
                font-size: 1.5rem !important; /* æ”¹å˜å­—å· */
                right: 2.2em !important;
                bottom: 1.1em !important;
                background: none !important;
                color: gray !important;
            }
            .reveal .navigate-left {
                right: 6em !important;
            }
            .reveal .navigate-right {
                right: 1em !important;
            }


            body.is-fullscreen header,
            body.is-fullscreen footer,
            body.is-fullscreen main > *:not(.reveal),
            body.is-fullscreen #fullscreen-btn {
                display: none;
            }
        </style>
        
        <!-- theme -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            var theme ='white';
            switch (theme){
                case 'black':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/black.min.css';
                    break;
                case 'beige':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/beige.min.css';
                    break;
                case 'blood':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/blood.min.css';
                    break;
                case 'league':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/league.min.css';
                    break;
                case 'moon':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/moon.min.css';
                    break;
                case 'night':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/night.min.css';
                    break;
                case 'serif':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/serif.min.css';
                    break;
                case 'sky':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/sky.min.css';
                    break;
                case 'solarized':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/solarized.min.css';
                    break;
                case 'white':
                    link.href = 'https://cdn.bootcss.com/reveal.js/3.4.1/css/theme/white.min.css';
                    break;
                default:
            }
            
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="https://cdn.bootcss.com/reveal.js/3.4.1/lib/css/zenburn.min.css">
        <link href="https://cdn.bootcss.com/reveal.js/3.4.1/css/print/paper.min.css" rel="stylesheet">
        <!-- Printing and PDF exports -->
        
    </head>
    <body>
        <div class="reveal">
            <button id="fullscreen-btn" title="å…¨å±æ˜¾ç¤º (ESCé€€å‡º)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                </svg>
            </button>
            <div class="slides">
                <section data-markdown
                         data-separator="^\n---\n"
                         data-separator-vertical="^\n--\n"
                         data-separator-notes="^Note:">
                    <script type="text/template">SVD Decompositon in LLM Compression



<small>Alephia</small>
<small>25/7/15</small>

---

## SVD Decomposition
å¯¹äºä»»æ„å®çŸ©é˜µ$W\in \mathbb{R}^{n\times m}$ï¼Œå…¶å­˜åœ¨å¦‚ä¸‹åˆ†è§£
$$
W = U\Sigma V^T
$$

å…¶ä¸­
$$
U\in \mathbb{R}^{m \times m}, V\in \mathbb{R}^{n\times n}, \Sigma \in \mathbb{R}^{m\times n}
$$
$\Sigma$åŒ…å«æ‰€æœ‰singular valueï¼Œ$U,V$ç”±å¯¹åº”æ–¹å‘ä¸Šçš„æ­£äº¤å‘é‡ç»„æˆ

æˆªå–$r$ä¸ªæœ€å¤§singular valueä¹‹åå¾—åˆ°$W$çš„æœ€ä¼˜$r$ç§©è¿‘ä¼¼
$$
W \approx U_{r}\Sigma_{r}V_{r}^T
$$


---

## Apply SVD in model Compression
å¯¹äºæ¨¡å‹å‚æ•°çŸ©é˜µ$W$ï¼Œå°è¯•å¯¹å…¶è¿›è¡Œå‚æ•°å‹ç¼©å¾—åˆ°$W_{k}$ï¼Œ$k$ä»£è¡¨å‹ç¼©åçš„çŸ©é˜µç§©ã€‚ç›´è§‚ç›®æ ‡å‡½æ•°å¯ä»¥å®šä¹‰ä¸º
$$
W_{k}^* = \mathop{\text{argmin}}\limits_{W_{k}} ||W_{k} - W||_{F}^2
$$

<p class="fragment">
ğŸ¤” Does this really enough?
</p>
<p class="fragment">
 <img src="https://s2.loli.net/2025/07/16/8QfV6R2zIuUkWdl.png " 
         style="width: 510px; height: auto; position: absolute; bottom: 90px; right: 0; border: none;">
</p>

<div class="slide-ref">
Hsu, Y., Hua, T., Chang, S., Lou, Q., Shen, Y., & Jin, H. (2022). Language model compression with weighted low-rank factorization.Â In ICLR, 22
</div>

---

## junk DNA hypothesis

<p class="fragment">
ğŸ’¡ Small-magnitude weights might seem nearly superfluous for <mark style="background: #FF5582A6;">simple downstream tasks</mark>
</p>
<p class="fragment">
ğŸ’¡ They actually <mark style="background: #FF5582A6;">encode vital knowledge</mark> essential for tackling more challenging downstream tasks
</p>
<p class="fragment">
ğŸ’¡ It's <mark style="background: #FF5582A6;">challenging to re-gain through fine-tuning</mark>, if these initial pre-trained weights are eliminated
</p>

<div class="slide-ref">
Lu, Y.,Shi, L. (2024)JUNK DNA HYPOTHESIS: A TASK-CENTRIC ANGLE OF LLM PRE-TRAINED WEIGHTS THROUGH SPARSITY
</div>

---

## Task-centric SVD for compression

$$
W^* = \mathop{argmin}\limits_{W'}\sum_{i,j}I_{W_{i,j}}(W_{i,j}-W_{i,j}')^2
$$
**Fisher Information**
$$
I_{w} = E\left[ \left( \frac{\partial}{\partial_{w}}\log p(D|w) \right)^2 \right]\approx \frac{1}{|D|}\sum_{i=1}^{D} \left( \frac{\partial}{\partial_{w}}L(d_{i};w) \right)^2 
$$
<p class="fragment">
æœ€ç»ˆæ•´ç†ä¸º
$$
W^* = \mathop{argmin}\limits_{W'}||IW-IW'||_{2}
$$
</p>

<div class="slide-ref">
Hsu, Y., Hua, T., Chang, S., Lou, Q., Shen, Y., & Jin, H. (2022). Language model compression with weighted low-rank factorization.Â In ICLR, 22
</div>

Note:
å½“lossæ˜¯ä»»åŠ¡ç›¸å…³çš„æ—¶å€™ï¼ŒæœŸæœ›åšSVDåˆ†è§£æ—¶ï¼Œé‡è¦çš„å‚æ•°åº”å½“è·å¾—è¾ƒå¤§çš„é‡è¦æ€§

---

## Task-centric SVD for compression

ç›®æ ‡å‡½æ•°å¯ä»¥æ›´æ–°ä¸º
$$
W^* = \mathop{\text{argmin}}\limits_{W'} ||W'X - WX||_{F}^2
$$
å¼•å…¥ä¸input activation$X$ ç›¸å…³çš„çŸ©é˜µ$S$ï¼Œå¾—åˆ°
$$
WX = (WS)(S^{-1}X)
$$

$$
S_{ii} = \left( \frac{1}{n} \sum_{j=1}^{n}|X_{ij}| \right)^{\alpha}
$$

<div class="slide-ref">
Yuan, Z., Shang, Y., Song, Y., Wu, Q., Yan, Y., & Sun, G. (2023). ASVD: Activation-aware Singular Value Decomposition for Compressing Large Language Models.Â 
</div>


Note:
ä¸¤ç§æ–¹å¼å…¶å®éƒ½æ˜¯æ·»åŠ äº†ä¸€ä¸ªtast specificçš„çŸ©é˜µï¼Œä¸€ä¸ªæ˜¯å‚æ•°å…³äºä»»åŠ¡ç›¸å…³lossçš„ä¿¡æ¯é‡ï¼Œä¸€ä¸ªæ˜¯input activationï¼Œä½†æ˜¯å‰è€…éœ€è¦è®¡ç®—æ¢¯åº¦ï¼Œç®—åŠ›æ¶ˆè€—å¤§

è¿™é‡Œæ˜¯å¯¹å…³äºXçš„çŸ©é˜µSï¼ŒWSè¿›è¡ŒSVDï¼Œè€Œä¸æ˜¯å¯¹WXè¿›è¡ŒSVDï¼Œä¸ªäººè®¤ä¸ºæ˜¯å¯¹Xè¿›è¡Œäº†ä¸€æ¬¡å¢å¼ºï¼Ÿ

ä»¥åŠæ—¢ç„¶æ˜¯task-centricï¼Œé‚£ä¹ˆä»…ä»…ç”¨ä¸€å°æ‰¹ï¼Œä¸€ä¸ªæ•°æ®é›†å¾—åˆ°çš„activationå¼•å¯¼åˆ†è§£ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä¸å¦¥ï¼Ÿ

---

## Task-centric SVD for compression

#### develop of S
å¯¹$XX^T$åš**Cholesky decomposition**ï¼Œå¾—åˆ°ä¸‹ä¸‰è§’çŸ©é˜µ$S$æ»¡è¶³
$$
SS^S = XX^T
$$
ä»è€Œ$S^{-1}X$æ˜¯æ­£äº¤çš„

$$
\begin{flalign}
L_{i} &= ||(W'S-WS)S^{-1}X ||\_{F}^2  \\\\
&= ||\text{SVD}(WS)-WS||\_{F}^2  \\\\
&= ||\sigma_{i}u_{i}v_{i}^T||\_{F}^2= \sigma_{i}^2
\end{flalign}
$$


<div class="slide-ref">
Wang, X., Zheng, Y., Wan, Z., & Zhang, M. (2024). SVD-LLM: Truncation-aware Singular Value Decomposition for Large Language Model Compression.Â In ICLR, 25
</div>

Note:
ä¸¢å¼ƒå¤šä¸ªsingular valueä¹Ÿèƒ½å¾—åˆ°ç±»ä¼¼çš„ç»“è®ºï¼Œè¯æ˜ç•¥è¿‡
å®ç°æŸå¤±ä¸singular valueçš„å€¼ä¸€ä¸€å¯¹åº”ï¼Œä»è€Œå¯ä»¥æ‘†è„±JUNK DNA HYPOTHESIS


---

## Task-centric SVD for compression
#### develop of S

<img src="https://s2.loli.net/2025/07/16/5VOBiadJfgTx3A7.png" style="width: 1000px; height: auto;  margin-top: auto; margin-bottom: auto;border: none;">



---



## Task-centric SVD for compression
#### Augmentation of input activation
å¼•å…¥
$$
\alpha_{j} = \sqrt{ x_{j}^T(XX^T)x_{j} } = ||x_{j}^TX||
$$
ä»£è¡¨$x_{j}$ä¸$X$å„ä¸ªé€šé“çš„å¯¹é½ç¨‹åº¦ï¼Œè¿›è€Œåæ˜ å…¶é‡è¦æ€§

$$
D_{jj} = 
\begin{cases}
a & \text{if } \alpha_{j} \text{ is among the top } p\\% \text{ values},\ a > 1 \\\\
1 & \text{otherwise}
\end{cases}
$$

$$
\tilde{X} = XD
$$

<div class="slide-ref">
Ding, X., Sun, R. (2025). DipSVD: Dual-importance Protected SVD for Efficient LLM Compression.
</div>

---

## Layer-wise compression ratio

<p class="fragment">
ğŸ¤” How to automatically assign layer-wise compression ratio
</p>
<br>

<p class="fragment">
ğŸ’¡é‡åŒ–æ¯ä¸€å±‚å‚æ•°ç›¸å¯¹äºtaskçš„é‡è¦æ€§  ->  Fisher Information
</p>
<p class="fragment">
$$
S_{l} = \sum_{Attention} \frac{||\nabla_{\theta}L||_{F}}{||\theta||_{F}} + \sum_{MLP} \frac{||\nabla_{\theta}L||_{F}}{||\theta||_{F}}
$$
</p>
<p class="fragment">
ğŸ’¡é‡åŒ–æ¯ä¸€å±‚çš„å¯å‹ç¼©ç¨‹åº¦
</p>
<p class="fragment">
$$
R_{l} = min\left\{  k| \frac{\sum_{i=1}^{k} \sigma_{i}}{\sum_{i=1}^{r}\sigma_{i}} \geq \text{ threshold} \right\}
$$
</p>

<div class="slide-ref">
Ding, X., Sun, R. (2025). DipSVD: Dual-importance Protected SVD for Efficient LLM Compression.
</div>

---

## Layer-wise compression ratio

#### observations on Llama-7B

$$
\begin{flalign}
&head_{i} = \text{Softmax}\left( \frac{X\textcolor{red}{W_{q_{i}}}(X\textcolor{red}{W_{k_{i}}})^T}{\sqrt{ d_{h} }}\right)X\textcolor{red}{W_{v_{i}}}\\\\
&MHA(X) = \text{Concat}(head_{1},\dots head_{h})\textcolor{red}{W_{o}}
\end{flalign}
$$

$$
FFN(X) = (X\textcolor{red}{W_{up}} \odot \sigma(X\textcolor{red}{W_{gate}}))\textcolor{red}{W_{down}}
$$

<p class="fragment">

<img src="https://s2.loli.net/2025/07/16/jyIoAZTSPDYUrda.png" style="width:380px; height: auto; float: right; margin-top: auto; margin-bottom: auto;border: none;">












<img src="https://s2.loli.net/2025/07/16/td74hf6Parv8ouz.png" style="width:380px; height: auto; float: left; margin-top: auto; margin-bottom: auto;border: none;">


</p>

---

## Layer-wise compression ratio

attentionä¸mlpç›¸æ¯”æœ‰æ•ˆç§©æ›´ä½ï¼Œå¯å‹ç¼©ç¨‹åº¦æ›´é«˜

<p class="fragment">
å¯¹æ¯ä¸€å±‚åˆ†é…ç»Ÿä¸€çš„compression ratioæ˜¯ä¸å¤Ÿåˆç†çš„ï¼Œattentionä¸mlpåº”å½“åˆ†å¼€å¤„ç†
</p>

<div class="slide-ref">
Li, G., Tang, Y., & Zhang, W. (2024). LoRAP: Transformer Sub-Layers Deserve Differentiated Structured Compression for Large Language Models. In ICML, 24
</div>

---

## The PATH Of LLM Compression



<img src="https://s2.loli.net/2025/07/03/bpJMwPvcWFok9Ns.png" style="width:700px; height: auto; float: center; margin-top: auto; margin-bottom: auto;border: none;">
<p class="fragment">
ğŸ¤” Factorization VS KD?
</p>
<p class="fragment">
å¯¹äºKDï¼Œå­¦ç”Ÿæ¨¡å‹çš„æ¶æ„æ˜¯æå‰è®¾è®¡å¥½çš„ï¼Œäº‹å®ä¸Šåº”è¯¥ä¹Ÿå¾ˆéš¾æå‰ç¡®å®šå¥½æœ€ä¼˜è§£ã€‚è€Œè¿›ä¸€æ­¥å‘æœ€ä¼˜è§£é è¿‘äº¤ç»™Matrix Decompositionæ¥è‡ªé€‚åº”è°ƒæ•´ã€‚
</p>

<p class="fragment">
KDç”¨äºçŸ¥è¯†è¿ç§»ï¼ŒMDç”¨äºå†—ä½™å‚æ•°ç§»é™¤ï¼Œä¸¤è€…çš„åŠŸèƒ½å…¶å®è¿˜æ˜¯ç›¸å¯¹æ­£äº¤çš„ã€‚
</p>

<p class="fragment">
é”¦ä¸Šæ·»èŠ±
</p>

Note:
SVDåˆ†è§£ä¸­ï¼Œåè€…ä¸€èˆ¬å‹ç¼©å‚æ•°çš„å¹…åº¦ä¸ä¼šå¾ˆå¤§ï¼Œ20%-30%å·¦å³ï¼Œå¹¶ä¸”ä¸€èˆ¬æ˜¯æœ‰æŸçš„ï¼Œè€ŒKDæœ‰æ¦‚ç‡å­¦ç”Ÿè¶…è¿‡å­¦ç”Ÿã€‚ä»¥åŠåè€…çš„æŸå¤±éƒ¨åˆ†ï¼Œé€šè¿‡å¾®è°ƒå¯èƒ½å¾ˆéš¾ä¿è¯èƒ½è¿˜åŸã€‚

---

## Conclusion
<p class="fragment">
The difinitation of objective function: <mark style="background: #FF5582A6;">junk-DNA-hypothesis</mark>, <mark style="background: #FF5582A6;">task-centric </mark>
</p>
<p class="fragment">
$$
W^* = \mathop{\text{argmin}}\limits_{W'} ||W'X - WX||_{F}^2
$$
</p>
<p class="fragment">
Designs of X and S
</p>
<p class="fragment">
Layer-wise compression ratio: <mark style="background: #FF5582A6;">importance</mark>, <mark style="background: #FF5582A6;">effective rank ratio</mark>
</p>
<p class="fragment">
treat Attention and MLP differently
</p>

---

## Thanks!

</script>

                </section>
            </div>
        </div>

        <!-- æ¿€å…‰ç¬” -->
        <button id="laser-btn" title="æ¿€å…‰ç¬”">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 5v2m0 10v2M5 12h2m10 0h2"/>
        </svg>
        </button>
        <div class="laser-pointer"></div>

        <!-- æ·»åŠ å­˜å‚¨ä¸­ï¼Œç”¨äºå­˜å‚¨æ¿€å…‰ç¬”ä½ç½®çš„è¾“å…¥æ¡† -->
        <input type="hidden" id="laser-position" value="">

        <script>
            window.MathJax = {
                tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']],
                    processEscapes: true,
                    processEnvironments: true,
                    packages: {'[+]': ['base', 'ams', 'amsmath', 'amssymb']}
                },
                options: {
                    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
                }
            };
        </script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

        <!-- <script src="https://cdn.bootcss.com/reveal.js/3.4.1/lib/js/head.min.js"></script>
        <script src="https://cdn.bootcss.com/reveal.js/3.4.1/js/reveal.min.js"></script> -->
        <!-- <script src="/reveal.js/plugin/math/mathjax2.js"></script> -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.2.1/dist/reveal.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.2.1/plugin/math/math.js"></script> -->
        <!-- <script src="/reveal.js/plugin/math/math.js"></script> -->

        <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.2.1/plugin/markdown/markdown.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.2.1/plugin/highlight/highlight.js"></script>

        <!-- Notesæ’ä»¶ -->
        <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.2.1/plugin/notes/notes.js"></script>



        <script>
            // More info https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                plugins: [ RevealMarkdown, RevealHighlight, RevealNotes],
                
                // math: {
                //     mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
                //     config: 'TeX-AMS_HTML-full',
                //     tex: {
                //         inlineMath: [['$', '$'], ['\\(', '\\)']],
                //         displayMath: [['$$', '$$'], ['\\[', '\\]']],
                //         processEscapes: true,
                //         processEnvironments: true,
                //         packages: {'[+]': ['ams', 'newcommand', 'configmacros']}
                //     }
                // },
                // å¹»ç¯ç‰‡è·ç¦»æµè§ˆå™¨è¾¹ç¼˜çš„ç™¾åˆ†æ¯”ï¼ˆ0 - 1ï¼‰
                margin: 0.1,  
                
                // ç¼©å°æ—¶æœ€å°ç¼©æ”¾æ¯”ä¾‹
                minScale: 0.2, 

                // æ”¾å¤§æ—¶æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
                maxScale: 2.0, 

                // åœ°å€æ  hash åæ˜ å½“å‰é¡µï¼Œæ–¹ä¾¿åˆ†äº«é“¾æ¥å®šä½åˆ°æŸé¡µ
                hash: true,

                history: true,

                // æ˜¯å¦åœ¨å³ä¸‹è§’å±•ç¤ºæ§åˆ¶æ¡
                controls: true,

                // æ˜¯å¦æ˜¾ç¤ºæ¼”ç¤ºçš„è¿›åº¦æ¡
                progress: true,

                // æ˜¯å¦æ˜¾ç¤ºå½“å‰å¹»ç¯ç‰‡çš„é¡µæ•°ç¼–å·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä»£ç  â€œslideNumber: 'c/t'â€ ï¼Œè¡¨ç¤ºå½“å‰é¡µ/æ€»é¡µæ•°ã€‚
                slideNumber: true,

                // æ˜¯å¦å°†æ¯ä¸ªå¹»ç¯ç‰‡æ”¹å˜åŠ å…¥åˆ°æµè§ˆå™¨çš„å†å²è®°å½•ä¸­å»
                history: false,

                // æ˜¯å¦å¯ç”¨é”®ç›˜å¿«æ·é”®æ¥å¯¼èˆª
                keyboard: true,

                // æ˜¯å¦å¯ç”¨å¹»ç¯ç‰‡çš„æ¦‚è§ˆæ¨¡å¼ï¼Œå¯ä½¿ç”¨ "Esc" æˆ– "o" é”®æ¥åˆ‡æ¢æ¦‚è§ˆæ¨¡å¼
                overview: true,

                // æ˜¯å¦å°†å¹»ç¯ç‰‡å‚ç›´å±…ä¸­
                center: true,

                // æ˜¯å¦åœ¨è§¦å±è®¾å¤‡ä¸Šå¯ç”¨è§¦æ‘¸æ»‘åŠ¨åˆ‡æ¢
                touch: true,

                // æ˜¯å¦å¾ªç¯æ¼”ç¤º
                loop: false,

                // æ˜¯å¦å°†æ¼”ç¤ºçš„æ–¹å‘å˜æˆ RTLï¼Œå³ä»å³å¾€å·¦
                rtl: false,

                // æ˜¯å¦æ¯æ¬¡æ¼”ç¤ºçš„æ—¶å€™ï¼Œéšæœºå¹»ç¯ç‰‡çš„é¡ºåº
                shuffle: false,

                // å…¨å±€å¼€å¯å’Œå…³é—­ç¢ç‰‡ã€‚
                fragments: true,

                // æ ‡è¯†æ¼”ç¤ºæ–‡ç¨¿æ˜¯å¦åœ¨åµŒå…¥æ¨¡å¼ä¸­è¿è¡Œï¼Œå³åŒ…å«åœ¨å±å¹•çš„æœ‰é™éƒ¨åˆ†ä¸­çš„
                embedded: false,

                // æ ‡è¯†å½“é—®å·é”®è¢«ç‚¹å‡»çš„æ—¶å€™æ˜¯å¦åº”è¯¥æ˜¾ç¤ºä¸€ä¸ªå¸®åŠ©çš„è¦†ç›–å±‚
                help: true,

                // æ ‡è¯†æ¼”è®²è€…å¤‡æ³¨æ ‡å¿—æ˜¯å¦è®©æ‰€æœ‰è§‚çœ‹è€…å¯è§
                showNotes: false,

                // ä¸¤ä¸ªå¹»ç¯ç‰‡ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢çš„æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰
                // å½“è®¾ç½®æˆ 0 çš„æ—¶å€™åˆ™ç¦æ­¢è‡ªåŠ¨åˆ‡æ¢
                // è¯¥å€¼å¯ä»¥è¢«å¹»ç¯ç‰‡ä¸Šçš„ â€œdata-autoslideâ€ å±æ€§è¦†ç›–
                autoSlide: 0,
                // å½“é‡åˆ°ç”¨æˆ·è¾“å…¥çš„æ—¶å€™åœæ­¢è‡ªåŠ¨åˆ‡æ¢
                autoSlideStoppable: true,
                // å½“è‡ªåŠ¨æ»‘åŠ¨æ—¶ï¼Œä½¿ç”¨æ­¤æ–¹æ³•è¿›è¡Œå¯¼èˆªã€‚
                autoSlideMethod: Reveal.navigateNext,

                // æ˜¯å¦å¯ç”¨é€šè¿‡é¼ æ ‡æ»šè½®æ¥å¯¼èˆªå¹»ç¯ç‰‡
                mouseWheel: true,

                // æ˜¯å¦åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šéšè—åœ°å€æ 
                hideAddressBar: true,
                // æ˜¯å¦åœ¨ä¸€ä¸ªå¼¹å‡ºçš„ iframe ä¸­æ‰“å¼€å¹»ç¯ç‰‡ä¸­çš„é“¾æ¥
                previewLinks: false,
                // åˆ‡æ¢è¿‡æ¸¡æ•ˆæœ
                transition: 'none', // none/fade/slide/convex/concave/zoom
                // è¿‡æ¸¡é€Ÿåº¦
                transitionSpeed: 'default', // default/fast/slow
                // å…¨å±å¹»ç¯ç‰‡èƒŒæ™¯çš„è¿‡æ¸¡æ•ˆæœ
                backgroundTransition: 'default', // none/fade/slide/convex/concave/zoom

                // åŠ è½½é™¤å½“å‰å¯è§çš„å¹»ç¯ç‰‡ä¹‹å¤–çš„å¹»ç¯ç‰‡æ•°é‡
                viewDistance: 3,

                // è§†å·®èƒŒæ™¯å›¾ç‰‡
                parallaxBackgroundImage: '',
                // e.g. 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'
                // è§†å·®èƒŒæ™¯å°ºå¯¸
                parallaxBackgroundSize: '', // CSS syntax, e.g. "2100px 900px"
                // ç§»åŠ¨è§†å·®èƒŒæ™¯ï¼ˆæ°´å¹³å’Œå‚ç›´ï¼‰æ»‘åŠ¨å˜åŒ–çš„æ•°é‡, ä¾‹å¦‚ 100
                // - é™¤äº†æŒ‡å®šè‡ªåŠ¨è®¡ç®—
                // - è®¾ç½®ä¸º 0 æ—¶ï¼Œç¦æ­¢æ²¿è½´è¿åŠ¨
                parallaxBackgroundHorizontal: null,
                parallaxBackgroundVertical: null,
            });
            Reveal.on('slidechanged', function() {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise();
                }
            });

            // è·å–æ‰€æœ‰éœ€è¦çš„å…ƒç´ 
            const revealElement = document.querySelector('.reveal');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const laserBtn = document.getElementById('laser-btn');
            const laserPointer = document.querySelector('.laser-pointer');
            const laserPositionInput = document.getElementById('laser-position');
            
            let isFullscreen = false;
            let isLaserActive = false;

            // æ£€æµ‹æ˜¯å¦åœ¨æ¼”ç¤ºè€…è§†å›¾ä¸­
            function isInPresenterView() {
                // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰speakeræˆ–noteså‚æ•°
                return window.location.search.includes('receiver');
            }

            // æ£€æµ‹æ˜¯å¦åœ¨å±•ç¤ºè§†å›¾ä¸­
            function isInPresentationView() {
            return !isInPresenterView() && window.opener;
            }
    
            // æ£€æµ‹æ˜¯å¦åœ¨ä¸»è§†å›¾
            function isInMainView() {
            return !isInPresenterView() && !window.opener;
            }
    
            // å®šä¹‰ä¸€ä¸ªç®€å•ç²—æš´çš„æœ¬åœ°å­˜å‚¨é”®ï¼Œç”¨äºåœ¨æ¼”ç¤ºè€…è§†å›¾å’Œå±•ç¤ºè§†å›¾ä¹‹é—´é€šä¿¡
            const LASER_KEY = 'reveal_laser_pointer_position';
            const LASER_ACTIVE_KEY = 'reveal_laser_active_state';

            // æ›´æ–°æ¿€å…‰ç¬”ä½ç½®çš„å‡½æ•°
            function updateLaserPosition(x, y, isVisible) {
                const positionData = {
                    x: x,
                    y: y,
                    isVisible: isVisible,
                    timestamp: Date.now()
                };
                
                // å­˜å‚¨åˆ°localStorage
                localStorage.setItem(LASER_KEY, JSON.stringify(positionData));
                
                // è§¦å‘ä¸€ä¸ªå­˜å‚¨äº‹ä»¶ï¼ˆè¿™åœ¨åŒä¸€ä¸ªçª—å£ä¸­ä¸ä¼šè‡ªåŠ¨è§¦å‘ï¼‰
                if (isInPresenterView()) {
                    const event = new Event('storage');
                    event.key = LASER_KEY;
                    event.newValue = JSON.stringify(positionData);
                    window.dispatchEvent(event);
                }
            }
            
            // åŒæ­¥æ¿€å…‰ç¬”çŠ¶æ€ï¼ˆæ¿€æ´»/éæ¿€æ´»ï¼‰
            function syncLaserActiveState(isActive) {
                // å­˜å‚¨æ¿€å…‰ç¬”æ¿€æ´»çŠ¶æ€
                localStorage.setItem(LASER_ACTIVE_KEY, isActive ? 'true' : 'false');
                
                // æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªå­˜å‚¨äº‹ä»¶ï¼Œè¿™æ ·åŒä¸€çª—å£ä¹Ÿèƒ½æ¥æ”¶
                if (isInPresenterView()) {
                    const event = new Event('storage');
                    event.key = LASER_ACTIVE_KEY;
                    event.newValue = isActive ? 'true' : 'false';
                    window.dispatchEvent(event);
                }
            }
            
            // æ¿€æ´»æˆ–ç¦ç”¨æ¿€å…‰ç¬”çš„å‡½æ•°
            function toggleLaser(activate) {
                isLaserActive = activate;
                
                if (isLaserActive) {
                    document.body.classList.add('cursor-hidden');
                    laserBtn.classList.add('active');
                } else {
                    document.body.classList.remove('cursor-hidden');
                    // ä½¿ç”¨hideLaserè¾…åŠ©å‡½æ•°ç¡®ä¿æ¿€å…‰ç¬”å®Œå…¨éšè—
                    hideLaser();
                    laserBtn.classList.remove('active');
                }
                
                // åŒæ­¥æ¿€å…‰ç¬”æ¿€æ´»çŠ¶æ€åˆ°å…¶ä»–è§†å›¾
                syncLaserActiveState(isLaserActive);
                }
                
                // æ¸…ç†æ¿€å…‰ç¬”çŠ¶æ€çš„å‡½æ•°
                function cleanupLaserPointer() {
                toggleLaser(false);
                isFullscreen = false;
                document.body.classList.remove('is-fullscreen');
                revealElement.classList.remove('fullscreen');
                laserBtn.style.display = 'none';
                // ä½¿ç”¨hideLaserè¾…åŠ©å‡½æ•°ç¡®ä¿æ¿€å…‰ç¬”å®Œå…¨éšè—
                hideLaser();
            }

            // å…¨å±æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            fullscreenBtn.addEventListener('click', function() {
                isFullscreen = !isFullscreen;
                document.body.classList.toggle('is-fullscreen', isFullscreen);
                revealElement.classList.toggle('fullscreen', isFullscreen);
                
                if (isFullscreen) {
                    document.documentElement.requestFullscreen();
                    laserBtn.style.display = 'flex';
                    Reveal.layout();
                } else {
                    cleanupLaserPointer();
                }
            });

            // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
            document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                cleanupLaserPointer();
                Reveal.layout();
            }
            });

            // æ¿€å…‰ç¬”æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            laserBtn.addEventListener('click', function() {
                toggleLaser(!isLaserActive);
            });

            // æ£€æµ‹æ¼”ç¤ºè€…è§†å›¾çš„æ¿€å…‰ç¬”ä½ç½®å¹¶åŒæ­¥
            window.addEventListener('storage', function(e) {
                // å¤„ç†æ¿€å…‰ç¬”ä½ç½®åŒæ­¥
                if (e.key === LASER_KEY && (isInMainView() || isInPresentationView())) {
                    try {
                        const data = JSON.parse(e.newValue);
                        
                        // è®¡ç®—å½“å‰çª—å£ä¸­çš„æ¿€å…‰ç¬”ä½ç½®
                        const revealRect = revealElement.getBoundingClientRect();
                        
                        if (data.isVisible && isLaserActive) {
                            // ä½¿ç”¨ç›¸å¯¹ä½ç½®è®¡ç®—æ¿€å…‰ç¬”ä½ç½®
                            const absX = data.x * revealRect.width + revealRect.left;
                            const absY = data.y * revealRect.height + revealRect.top;
                            
                            // æ›´æ–°æ¿€å…‰ç¬”ä½ç½®
                            requestAnimationFrame(() => {
                            laserPointer.style.display = 'block';
                            laserPointer.style.left = (absX - 4) + 'px';
                            laserPointer.style.top = (absY - 4) + 'px';
                            });
                        } else {
                            // éšè—æ¿€å…‰ç¬”
                            requestAnimationFrame(() => {
                            laserPointer.style.display = 'none';
                            laserPointer.style.left = '-9999px';
                            laserPointer.style.top = '-9999px';
                            });
                        }
                    } 
                    catch (err) {
                        console.error('è§£ææ¿€å…‰ç¬”æ•°æ®å¤±è´¥', err);
                        // å‡ºé”™æ—¶ä¹Ÿç¡®ä¿æ¿€å…‰ç¬”éšè—
                        requestAnimationFrame(() => {
                            laserPointer.style.display = 'none';
                            laserPointer.style.left = '-9999px';
                            laserPointer.style.top = '-9999px';
                        });
                    }
                }
            
                // å¤„ç†æ¿€å…‰ç¬”æ¿€æ´»çŠ¶æ€åŒæ­¥
                if (e.key === LASER_ACTIVE_KEY && (isInMainView() || isInPresentationView())) {
                    const isActive = e.newValue === 'true';
                    console.log('æ¥æ”¶åˆ°æ¿€å…‰ç¬”çŠ¶æ€åŒæ­¥:', isActive);
                    
                    // åªæ›´æ–°UIçŠ¶æ€ï¼Œä¸å†è§¦å‘äº‹ä»¶ï¼Œé¿å…å¾ªç¯
                    isLaserActive = isActive;
                    
                    if (isActive) {
                        laserBtn.classList.add('active');
                        document.body.classList.add('cursor-hidden');
                    } else {
                        laserBtn.classList.remove('active');
                        document.body.classList.remove('cursor-hidden');
                        // ä½¿ç”¨hideLaserè¾…åŠ©å‡½æ•°ç¡®ä¿æ¿€å…‰ç¬”å®Œå…¨éšè—
                        hideLaser();
                    }
                }
            });
        
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            document.addEventListener('mousemove', function(e) {
                // åªæœ‰å½“æ¿€å…‰ç¬”æ¿€æ´»æ—¶æ‰å¤„ç†
                if (isLaserActive) {
                    const revealRect = revealElement.getBoundingClientRect();
                    const isInsideReveal = (
                    e.clientX >= revealRect.left &&
                    e.clientX <= revealRect.right &&
                    e.clientY >= revealRect.top &&
                    e.clientY <= revealRect.bottom
                    );
            
                    if (isInsideReveal) {
                    // è®¡ç®—ç›¸å¯¹ä½ç½®
                    const relX = (e.clientX - revealRect.left) / revealRect.width;
                    const relY = (e.clientY - revealRect.top) / revealRect.height;
                    
                    // åœ¨æœ¬çª—å£ä¸­æ˜¾ç¤ºæ¿€å…‰ç¬”
                    requestAnimationFrame(() => {
                        laserPointer.style.display = 'block';
                        laserPointer.style.left = (e.clientX - 4) + 'px';
                        laserPointer.style.top = (e.clientY - 4) + 'px';
                    });
                    
                    // å°†ä½ç½®ä¿¡æ¯åŒæ­¥åˆ°å…¶ä»–çª—å£
                    if (isInPresenterView()) {
                        updateLaserPosition(relX, relY, true);
                    }
                    } else {
                    // ç¡®ä¿æ¿€å…‰ç¬”å®Œå…¨éšè—
                    requestAnimationFrame(() => {
                        laserPointer.style.display = 'none';
                        laserPointer.style.left = '-9999px';
                        laserPointer.style.top = '-9999px';
                    });
                    
                    // é€šçŸ¥å…¶ä»–çª—å£éšè—æ¿€å…‰ç¬”
                    if (isInPresenterView()) {
                        updateLaserPosition(0, 0, false);
                    }
                    }
                } else {
                    // å¦‚æœæ¿€å…‰ç¬”æœªæ¿€æ´»ï¼Œç¡®ä¿å®ƒè¢«éšè—
                    requestAnimationFrame(() => {
                    laserPointer.style.display = 'none';
                    laserPointer.style.left = '-9999px';
                    laserPointer.style.top = '-9999px';
                    });
                }
            });
        
            // é¼ æ ‡ç¦»å¼€çª—å£äº‹ä»¶
            document.addEventListener('mouseleave', function() {
                if (isLaserActive) {
                    // ä½¿ç”¨hideLaserè¾…åŠ©å‡½æ•°ç¡®ä¿æ¿€å…‰ç¬”å®Œå…¨éšè—
                    hideLaser();
                }
            });
        
            // é¼ æ ‡è¿›å…¥çª—å£äº‹ä»¶
            document.addEventListener('mouseenter', function(e) {
                if (isLaserActive) {
                    const revealRect = revealElement.getBoundingClientRect();
                    const isInsideReveal = (
                    e.clientX >= revealRect.left &&
                    e.clientX <= revealRect.right &&
                    e.clientY >= revealRect.top &&
                    e.clientY <= revealRect.bottom
                    );
            
                    if (isInsideReveal && isInPresenterView()) {
                    // è®¡ç®—ç›¸å¯¹ä½ç½®
                    const relX = (e.clientX - revealRect.left) / revealRect.width;
                    const relY = (e.clientY - revealRect.top) / revealRect.height;
                    
                    // æ›´æ–°æ¿€å…‰ç¬”ä½ç½®
                    updateLaserPosition(relX, relY, true);
                    }
                }
            });

            // ESC é”®å¤„ç†
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // åŒºåˆ†æ¼”ç¤ºè€…è§†å›¾å’Œå…¶ä»–è§†å›¾çš„å¤„ç†
                    if (isInPresenterView()) {
                    // åœ¨æ¼”ç¤ºè€…è§†å›¾ä¸­ï¼ŒESC é”®åªé€€å‡ºå…¨å±ï¼Œä¸å…³é—­æ¿€å…‰ç¬”
                    if (isFullscreen || document.fullscreenElement) {
                        if (document.fullscreenElement) {
                        document.exitFullscreen();
                        }
                        isFullscreen = false;
                        document.body.classList.remove('is-fullscreen');
                        revealElement.classList.remove('fullscreen');
                        // ä¸å…³é—­æ¿€å…‰ç¬”ï¼Œä½†åœ¨æ¼”è®²è€…æ¨¡å¼ä¸‹æŒ‰é’®ä¿æŒéšè—
                        laserBtn.style.display = 'none';
                        Reveal.layout();
                    }
                    } else {
                    // åœ¨å…¶ä»–è§†å›¾ä¸­ï¼ŒESC é”®è¡Œä¸ºä¸å˜
                    cleanupLaserPointer();
                    }
                }
                    // Alt é”®åˆ‡æ¢æ¿€å…‰ç¬”ï¼ˆåœ¨æ‰€æœ‰è§†å›¾ä¸­éƒ½æœ‰æ•ˆï¼‰
                if (e.key === 'Alt') {
                    e.preventDefault(); // é˜²æ­¢è§¦å‘æµè§ˆå™¨é»˜è®¤è¡Œä¸º
                    toggleLaser(!isLaserActive);
                }
            });
                
            // æ·»åŠ  Alt é”®é‡Šæ”¾å¤„ç†
            document.addEventListener('keyup', function(e) {
            if (e.key === 'Alt') {
                e.preventDefault(); // é˜²æ­¢è§¦å‘æµè§ˆå™¨é»˜è®¤è¡Œä¸º
            }
            });

            // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ¿€å…‰ç¬”æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            window.addEventListener('load', function() {
                // å¦‚æœæ˜¯æ¼”ç¤ºè€…è§†å›¾ï¼Œä¸æ˜¾ç¤ºæ¿€å…‰ç¬”æŒ‰é’®å’Œå…¨å±æŒ‰é’®
                if (isInPresenterView()) {
                    console.log('å½“å‰æ˜¯æ¼”ç¤ºè€…è§†å›¾ï¼Œéšè—æ¿€å…‰ç¬”æŒ‰é’®å’Œå…¨å±æŒ‰é’®');
                    laserBtn.style.display = 'none';
                    fullscreenBtn.style.display = 'none';
                }
                
                // å¦‚æœæ˜¯å±•ç¤ºè§†å›¾æˆ–ä¸»è§†å›¾ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ¿€å…‰ç¬”ä½ç½®ä¿¡æ¯
                if (isInPresentationView() || isInMainView()) {
                    console.log('å½“å‰æ˜¯å±•ç¤ºè§†å›¾æˆ–ä¸»è§†å›¾ï¼Œå‡†å¤‡æ¥æ”¶æ¿€å…‰ç¬”ä½ç½®');
                    
                    // æ£€æŸ¥æ¿€å…‰ç¬”æ¿€æ´»çŠ¶æ€
                    const laserActiveState = localStorage.getItem(LASER_ACTIVE_KEY);
                    if (laserActiveState === 'true') {
                    console.log('æ£€æµ‹åˆ°æ¿€å…‰ç¬”å¤„äºæ¿€æ´»çŠ¶æ€');
                    isLaserActive = true;
                    laserBtn.classList.add('active');
                    document.body.classList.add('cursor-hidden');
                    } else {
                    // å¦‚æœæ¿€å…‰ç¬”æœªæ¿€æ´»ï¼Œç¡®ä¿å®ƒè¢«éšè—
                    requestAnimationFrame(() => {
                        laserPointer.style.display = 'none';
                        laserPointer.style.left = '-9999px';
                        laserPointer.style.top = '-9999px';
                    });
                    }
                    
                    // ç«‹å³æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„æ¿€å…‰ç¬”ä½ç½®
                    const storedPosition = localStorage.getItem(LASER_KEY);
                    if (storedPosition) {
                    try {
                        const data = JSON.parse(storedPosition);
                        // å¦‚æœæ•°æ®ä¸æ˜¯å¤ªæ—§ï¼ˆ10ç§’å†…ï¼‰ï¼Œå¹¶ä¸”æ¿€å…‰ç¬”å½“å‰å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œåˆ™åº”ç”¨å®ƒ
                        if (Date.now() - data.timestamp < 10000 && data.isVisible && isLaserActive) {
                        const revealRect = revealElement.getBoundingClientRect();
                        const absX = data.x * revealRect.width + revealRect.left;
                        const absY = data.y * revealRect.height + revealRect.top;
                        
                        requestAnimationFrame(() => {
                            laserPointer.style.display = 'block';
                            laserPointer.style.left = (absX - 4) + 'px';
                            laserPointer.style.top = (absY - 4) + 'px';
                        });
                        } else {
                        // æ•°æ®è¿‡æœŸæˆ–æ¿€å…‰ç¬”æœªæ¿€æ´»ï¼Œç¡®ä¿æ¿€å…‰ç¬”éšè—
                        requestAnimationFrame(() => {
                            laserPointer.style.display = 'none';
                            laserPointer.style.left = '-9999px';
                            laserPointer.style.top = '-9999px';
                        });
                        }
                    } catch (err) {
                        console.error('è§£æå­˜å‚¨çš„æ¿€å…‰ç¬”ä½ç½®å¤±è´¥', err);
                        // è§£æå¤±è´¥æ—¶éšè—æ¿€å…‰ç¬”
                        requestAnimationFrame(() => {
                        laserPointer.style.display = 'none';
                        laserPointer.style.left = '-9999px';
                        laserPointer.style.top = '-9999px';
                        });
                    }
                    }
                }
            });

            // æ£€æµ‹æ¼”ç¤ºçª—å£çš„å…³é—­ï¼Œä»¥ä¾¿æ›´æ–°çŠ¶æ€
            window.addEventListener('beforeunload', function() {
                // å¦‚æœæ˜¯æ¼”ç¤ºè€…è§†å›¾ï¼Œé€šçŸ¥å…¶ä»–è§†å›¾ä¸å†è‡ªåŠ¨å…¨å±
                if (isInPresenterView()) {
                    localStorage.removeItem('reveal_auto_fullscreen');
                    localStorage.removeItem('reveal_auto_fullscreen_timestamp');
                }
            });

            // æ›´æ–°æ¿€å…‰ç¬”æŒ‰é’®çš„æç¤ºæ–‡å­—
            document.querySelector('#laser-btn').title = 'æ¿€å…‰ç¬” (Alt + O åˆ‡æ¢)';

            // çª—å£å¤§å°æ”¹å˜äº‹ä»¶ - æ¢å¤æ­¤äº‹ä»¶å¤„ç†ä»¥ä¾¿åœ¨è°ƒæ•´å¤§å°æ—¶æ­£ç¡®å¤„ç†æ¿€å…‰ç¬”
            window.addEventListener('resize', function() {
            if (!isFullscreen) {
                cleanupLaserPointer();
            }
            });

            // ä¸ºä¸»åŠ¨éšè—æ¿€å…‰ç¬”æ·»åŠ ä¸€ä¸ªå¸®åŠ©å‡½æ•°
            function hideLaser() {
                requestAnimationFrame(() => {
                    laserPointer.style.display = 'none';
                    laserPointer.style.left = '-9999px';
                    laserPointer.style.top = '-9999px';
                });
                
                if (isInPresenterView()) {
                    updateLaserPosition(0, 0, false);
                }
            }

            // ç¡®ä¿åœ¨çª—å£å¤±å»ç„¦ç‚¹æ—¶éšè—æ¿€å…‰ç¬”
            window.addEventListener('blur', function() {
                if (isLaserActive) {
                    hideLaser();
                }
                });
                
                // ç¡®ä¿åœ¨é¡µé¢å¯è§æ€§æ”¹å˜æ—¶å¤„ç†æ¿€å…‰ç¬”
                document.addEventListener('visibilitychange', function() {
                if (document.hidden && isLaserActive) {
                    hideLaser();
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                const refs = document.querySelectorAll('.slide-ref');

                refs.forEach(ref => {
                    const lines = ref.textContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                    ref.innerHTML = `
                    <div style="width: 100px; height: 1px; background: black; margin-bottom: 5px;"></div>
                    <p style="margin: 2px 0;">${lines.join('<br>')}</p>
                    `;
                });
            });



        </script>
    </body>
</html>
